<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HavaDurumuhd Pro | Modern Weather App</title>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1163/1163624.png" />

    <!-- SCRIPTS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            overflow: hidden;
            background-color: #0f172a;
            color: #fff;
            touch-action: manipulation;
        }

        #root {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            position: relative;
        }

        /* --- KATMANLAR --- */
        .bg-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .content-layer {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* HAVA EFEKTLERİ */
        .weather-bg-container { width: 100%; height: 100%; overflow: hidden; position: relative; }
        .bg-sun { background: linear-gradient(to bottom, #0284c7, #38bdf8); }
        .bg-cloud { background: linear-gradient(to bottom, #475569, #94a3b8); }
        .bg-rain { background: linear-gradient(to bottom, #1e293b, #334155); }
        .bg-snow { background: linear-gradient(to bottom, #cbd5e1, #f8fafc); }
        .bg-storm { background: linear-gradient(to bottom, #020617, #1e293b); }

        /* Yağmur/Kar animasyonları */
        .heavy-rain { position: absolute; background: rgba(255,255,255,0.4); width: 1px; height: 30px; animation: rainFall 0.5s linear infinite; }
        @keyframes rainFall { to { transform: translateY(110vh); } }
        .big-snow { position: absolute; background: white; border-radius: 50%; opacity: 0.8; animation: snowFall 5s linear infinite; }
        @keyframes snowFall { to { transform: translateY(110vh) rotate(360deg); } }

        /* KART VE UI */
        .weather-card {
            position: relative;
            width: 92%;
            max-width: 480px;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 40px;
            padding: 2rem 1.5rem;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin: 10px auto;
        }

        .hourly-scroll {
            width: 92%;
            max-width: 480px;
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 10px 5px 20px 5px;
            scrollbar-width: none;
        }
        .hourly-scroll::-webkit-scrollbar { display: none; }

        .hourly-item {
            min-width: 85px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 16px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        .hourly-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-5px);
            border-color: rgba(255,255,255,0.3);
        }

        .glass-bar {
            background: rgba(255, 255, 255, 0.95);
            color: #0f172a;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .glass-bar:active { transform: scale(0.92); }

        .search-container {
            width: 92%; max-width: 480px; display: flex; gap: 8px; align-items: center; padding: 6px;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(15px); border-radius: 35px; border: 1px solid rgba(255,255,255,0.1);
        }

        #profile-export-container {
            position: fixed; top: 0; left: -2000px; width: 1080px; height: 1920px; z-index: -9999; overflow: hidden;
        }

        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const TR_CITIES = [
            "Adana", "Adıyaman", "Afyonkarahisar", "Ağrı", "Aksaray", "Amasya", "Ankara", "Antalya", "Ardahan", "Artvin", "Aydın", 
            "Balıkesir", "Bartın", "Batman", "Bayburt", "Bilecik", "Bingöl", "Bitlis", "Bolu", "Burdur", "Bursa", 
            "Çanakkale", "Çankırı", "Çorum", "Denizli", "Diyarbakır", "Düzce", "Edirne", "Elazığ", "Erzincan", "Erzurum", "Eskişehir", 
            "Gaziantep", "Giresun", "Gümüşhane", "Hakkari", "Hatay", "Iğdır", "Isparta", "İstanbul", "İzmir", 
            "Kahramanmaraş", "Karabük", "Karaman", "Kars", "Kastamonu", "Kayseri", "Kırıkkale", "Kırklareli", "Kırşehir", "Kilis", "Kocaeli", "Konya", "Kütahya", 
            "Malatya", "Manisa", "Mardin", "Mersin", "Muğla", "Muş", "Nevşehir", "Niğde", "Ordu", "Osmaniye", 
            "Rize", "Sakarya", "Samsun", "Siirt", "Sinop", "Sivas", "Şanlıurfa", "Şırnak", 
            "Tekirdağ", "Tokat", "Trabzon", "Tunceli", "Uşak", "Van", "Yalova", "Yozgat", "Zonguldak"
        ].sort((a, b) => a.localeCompare(b, 'tr'));

        const getWeatherInfo = (code) => {
            const map = {
                0: {t:"Güneşli", i:"sun", type:"sun", advice: "Güneş kremi sürmeyi unutma!"}, 
                1: {t:"Az Bulutlu", i:"cloud-sun", type:"partly-cloudy", advice: "Hava harika, tadını çıkar."}, 
                2: {t:"Parçalı Bulutlu", i:"cloud-sun", type:"cloud", advice: "Bulutlar güneşle dans ediyor."}, 
                3: {t:"Kapalı", i:"cloud", type:"cloud", advice: "Gri ama huzurlu bir gün."}, 
                45: {t:"Sisli", i:"cloud-fog", type:"cloud", advice: "Görüş mesafesi düşük, dikkat!"}, 
                51: {t:"Çiseleme", i:"cloud-drizzle", type:"rain", advice: "Hafif bir yağmur geçişi var."}, 
                61: {t:"Yağmur", i:"cloud-rain", type:"rain", advice: "Şemsiyeni mutlaka yanına al!"}, 
                63: {t:"Sağanak", i:"cloud-rain", type:"rain", advice: "Dışarı çıkarken dikkat et, ıslanma."}, 
                71: {t:"Kar", i:"snowflake", type:"snow", advice: "Lapa lapa kar yağıyor!"},
                95: {t:"Fırtına", i:"cloud-lightning", type:"storm", advice: "Gök gürültüsüne hazırlıklı ol!"}
            };
            return map[code] || {t:"Bulutlu", i:"cloud", type:"cloud", advice: "Hava değişken olabilir."};
        };

        const LucideIcon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name, size]);
            return (
                <span className={`inline-flex items-center justify-center overflow-hidden ${className}`} style={{ width: size, height: size }}>
                    <i data-lucide={name} style={{ width: size, height: size }}></i>
                </span>
            );
        };

        const BackgroundEffect = ({ type, isDay }) => {
            const elements = useMemo(() => {
                if (type === 'rain') return Array.from({ length: 60 }).map((_, i) => <div key={i} className="heavy-rain" style={{ left: `${Math.random()*100}%`, animationDuration: `${0.4+Math.random()*0.4}s`, animationDelay: `-${Math.random()}s` }} />);
                if (type === 'snow') return Array.from({ length: 40 }).map((_, i) => <div key={i} className="big-snow" style={{ left: `${Math.random()*100}%`, width: `${4+Math.random()*8}px`, height: `${4+Math.random()*8}px`, animationDuration: `${4+Math.random()*4}s` }} />);
                return null;
            }, [type]);
            return <div className={`weather-bg-container ${'bg-'+type}`}>{elements}</div>;
        };

        const App = () => {
            const [selectedCity, setSelectedCity] = useState(localStorage.getItem('lastCity') || "Eskişehir");
            const [weather, setWeather] = useState(null);
            const [hourly, setHourly] = useState([]);
            const [forecast, setForecast] = useState([]);
            const [avatar, setAvatar] = useState(localStorage.getItem('userAvatar') || null);
            const [loading, setLoading] = useState(false);
            const [panels, setPanels] = useState({ fav: false, forecast: false });
            const [favs, setFavs] = useState(JSON.parse(localStorage.getItem('favCities') || '[]'));

            const fetchWeather = async (city) => {
                setLoading(true);
                try {
                    const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=tr&format=json`).then(r=>r.json());
                    if (!geo.results) return;
                    const { latitude, longitude, name } = geo.results[0];
                    const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max&timezone=auto`).then(r=>r.json());
                    
                    setWeather({
                        city: name.toLocaleUpperCase('tr-TR'),
                        temp: Math.round(w.current.temperature_2m),
                        feels: Math.round(w.current.apparent_temperature),
                        humidity: w.current.relative_humidity_2m,
                        wind: w.current.wind_speed_10m,
                        rain: w.current.precipitation,
                        code: w.current.weather_code,
                        isDay: w.current.is_day === 1,
                        uv: w.daily.uv_index_max[0],
                        sunrise: w.daily.sunrise[0].split('T')[1],
                        sunset: w.daily.sunset[0].split('T')[1]
                    });

                    // Saatlik tahmin (Önümüzdeki 24 saat)
                    const now = new Date();
                    const currentHour = now.getHours();
                    
                    // Veriyi daha temiz çekiyoruz
                    const next24 = w.hourly.time.slice(currentHour, currentHour + 24).map((t, i) => {
                        const timeStr = t.split('T')[1]; // "14:00"
                        return {
                            time: timeStr,
                            temp: Math.round(w.hourly.temperature_2m[currentHour + i]),
                            icon: getWeatherInfo(w.hourly.weather_code[currentHour + i]).i
                        };
                    });
                    setHourly(next24);

                    setForecast(w.daily.time.map((t, i) => ({
                        day: new Date(t).toLocaleDateString('tr-TR', { weekday: 'short' }),
                        max: Math.round(w.daily.temperature_2m_max[i]),
                        min: Math.round(w.daily.temperature_2m_min[i]),
                        icon: getWeatherInfo(w.daily.weather_code[i]).i
                    })));

                    localStorage.setItem('lastCity', city);
                } catch (e) { console.error(e); }
                finally { setLoading(false); }
            };

            const detectLocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=tr`)
                        .then(r=>r.json()).then(data => {
                            const city = data.city || data.principalSubdivision;
                            if (city) {
                                setSelectedCity(city);
                                fetchWeather(city);
                            }
                        });
                    }, (err) => {
                        console.warn("Konum erişimi reddedildi.");
                    });
                }
            };

            useEffect(() => { fetchWeather(selectedCity); }, []);

            const wInfo = weather ? getWeatherInfo(weather.code) : {t:"...", i:"cloud", type:"cloud", advice:""};

            const downloadStory = () => {
                const el = document.getElementById('profile-export-container');
                el.style.left = "0px";
                html2canvas(el, { scale: 2, useCORS: true, backgroundColor: "#0f172a" }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${selectedCity}_HavaDurumu.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    el.style.left = "-2000px";
                });
            };

            return (
                <div className="w-full h-full flex flex-col overflow-hidden">
                    <div className="bg-layer">{weather && <BackgroundEffect type={wInfo.type} isDay={weather.isDay} />}</div>
                    
                    <div className="content-layer">
                        {/* Arama Barı */}
                        <div className="search-container animate-pop">
                            <button onClick={detectLocation} className="glass-bar p-3 text-blue-600" title="Konumumu Bul"><LucideIcon name="map-pin" /></button>
                            <div className="flex-1 relative">
                                <select 
                                    value={selectedCity} 
                                    onChange={(e) => { setSelectedCity(e.target.value); fetchWeather(e.target.value); }}
                                    className="w-full bg-transparent border-none outline-none font-black text-gray-100 text-center text-lg appearance-none cursor-pointer"
                                >
                                    {TR_CITIES.map(c => <option key={c} value={c} className="text-black">{c}</option>)}
                                </select>
                            </div>
                            <button onClick={() => setPanels({...panels, fav: true})} className="glass-bar p-3" title="Favoriler"><LucideIcon name="list" /></button>
                        </div>

                        {/* Ana Hava Kartı */}
                        <div className="weather-card animate-pop">
                            {weather ? (
                                <>
                                    <p className="text-sm font-bold tracking-[0.3em] opacity-80 mb-2 uppercase">Günün Özeti: {wInfo.t}</p>
                                    <h1 className="text-5xl font-black mb-4 drop-shadow-lg">{weather.city}</h1>
                                    
                                    <div className="flex items-center justify-center gap-6 mb-6">
                                        <LucideIcon name={wInfo.i} size={84} className="text-white drop-shadow-xl" />
                                        <div className="text-left">
                                            <span className="text-8xl font-black block leading-none">{weather.temp}°</span>
                                            <span className="text-lg font-bold opacity-80 italic">Hissedilen: {weather.feels}°</span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-3 gap-2 bg-black/20 p-4 rounded-3xl border border-white/10">
                                        <div className="flex flex-col items-center"><span className="text-[10px] uppercase opacity-60 mb-1">Nem</span><span className="font-bold text-sm">%{weather.humidity}</span></div>
                                        <div className="flex flex-col items-center"><span className="text-[10px] uppercase opacity-60 mb-1">Rüzgar</span><span className="font-bold text-sm">{weather.wind} km/s</span></div>
                                        <div className="flex flex-col items-center"><span className="text-[10px] uppercase opacity-60 mb-1">UV İndeks</span><span className="font-bold text-sm">{weather.uv}</span></div>
                                    </div>

                                    <div className="mt-6 p-4 bg-white/10 rounded-2xl text-xs sm:text-sm font-bold flex items-center justify-center gap-3 border border-white/5">
                                        <LucideIcon name="info" size={18} className="text-yellow-400 shrink-0"/>
                                        <span className="leading-tight">{wInfo.advice}</span>
                                    </div>
                                </>
                            ) : <div className="p-10 font-black animate-pulse flex flex-col items-center gap-4"><LucideIcon name="loader-2" className="animate-spin" size={40}/> Veriler Alınıyor...</div>}
                        </div>

                        {/* Saatlik Tahmin */}
                        <div className="w-[92%] max-w-[480px] mt-6 px-2">
                            <h3 className="text-xs font-black uppercase tracking-[0.2em] mb-4 flex items-center gap-2 opacity-90">
                                <LucideIcon name="clock" size={14}/> 24 Saatlik Akış
                            </h3>
                            <div className="hourly-scroll">
                                {hourly.map((h, i) => (
                                    <div key={i} className="hourly-item">
                                        <span className="text-[10px] font-bold opacity-60 mb-3">{h.time}</span>
                                        <LucideIcon name={h.icon} size={28} className="mb-3 text-white" />
                                        <span className="text-lg font-black">{h.temp}°</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Alt Butonlar */}
                        <div className="flex gap-5 my-6">
                            <button onClick={() => setPanels({...panels, forecast: true})} className="glass-bar w-16 h-16" title="Haftalık Tahmin"><LucideIcon name="calendar" size={28}/></button>
                            <button onClick={downloadStory} className="glass-bar w-16 h-16 text-pink-600" title="Instagram Story Paylaş"><LucideIcon name="instagram" size={28}/></button>
                            <button onClick={() => fetchWeather(selectedCity)} className="glass-bar w-16 h-16 text-indigo-600" title="Yenile"><LucideIcon name="refresh-cw" size={28}/></button>
                        </div>
                    </div>

                    {/* Yan Panel: Haftalık Tahmin */}
                    <div className={`fixed inset-0 z-[100] transition-all duration-300 ${panels.forecast ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}>
                        <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={() => setPanels({...panels, forecast: false})}></div>
                        <div className={`absolute bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-xl p-8 rounded-t-[40px] border-t border-white/10 transition-transform duration-500 shadow-[0_-20px_50px_rgba(0,0,0,0.5)] ${panels.forecast ? 'translate-y-0' : 'translate-y-full'}`}>
                            <div className="w-16 h-1.5 bg-white/20 mx-auto mb-8 rounded-full cursor-pointer" onClick={() => setPanels({...panels, forecast: false})}></div>
                            <div className="flex justify-between items-center mb-8">
                                <h2 className="text-2xl font-black">Haftalık Tahmin</h2>
                                <LucideIcon name="calendar-days" className="text-blue-400" size={24}/>
                            </div>
                            <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2 scrollbar-hide">
                                {forecast.map((d, i) => (
                                    <div key={i} className="flex items-center justify-between p-5 bg-white/5 rounded-3xl border border-white/5 hover:bg-white/10 transition-colors">
                                        <span className="font-bold w-16 text-lg">{d.day}</span>
                                        <LucideIcon name={d.icon} size={32} className="text-blue-200" />
                                        <div className="font-black text-right min-w-[80px]">
                                            <span className="text-xl text-white">{d.max}°</span>
                                            <span className="text-base text-white/40 ml-3">{d.min}°</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* STORY EXPORT (Gizli Katman) */}
                    <div id="profile-export-container">
                        <div className={`absolute inset-0 ${'bg-'+wInfo.type}`}>
                             {avatar && <div className="absolute inset-0 opacity-40 blur-3xl scale-150" style={{backgroundImage: `url(${avatar})`, backgroundSize:'cover'}}></div>}
                             <div className="absolute inset-0 bg-black/30"></div>
                        </div>
                        <div className="relative z-10 h-full flex flex-col items-center justify-center p-20 text-center">
                            <div className="mb-10">
                                <p className="text-4xl font-bold tracking-[0.5em] opacity-80 mb-4 uppercase">HavaDurumuhd</p>
                                <h1 className="text-[130px] font-black uppercase drop-shadow-2xl leading-tight">{weather?.city}</h1>
                            </div>
                            
                            <LucideIcon name={wInfo.i} size={320} className="mb-10 drop-shadow-2xl text-white"/>
                            
                            <div className="flex flex-col items-center">
                                <span className="text-[380px] font-black leading-none tracking-tighter drop-shadow-2xl">{weather?.temp}°</span>
                                <div className="bg-white/15 backdrop-blur-2xl px-12 py-8 rounded-[60px] border border-white/25 w-full mt-8 shadow-2xl">
                                    <p className="text-7xl font-black uppercase tracking-[12px] mb-4">{wInfo.t}</p>
                                    <p className="text-4xl font-bold italic opacity-90">"{wInfo.advice}"</p>
                                </div>
                            </div>

                            <div className="mt-auto pt-20 flex gap-16 text-4xl font-bold opacity-80">
                                <div className="flex items-center gap-4"><LucideIcon name="droplets" size={40}/> %{weather?.humidity}</div>
                                <div className="flex items-center gap-4"><LucideIcon name="wind" size={40}/> {weather?.wind} km/s</div>
                                <div className="flex items-center gap-4"><LucideIcon name="sun" size={40}/> UV {weather?.uv}</div>
                            </div>
                            
                            <div className="mt-16 text-3xl font-bold tracking-[10px] opacity-60 uppercase">
                                {new Date().toLocaleDateString('tr-TR', { day:'numeric', month:'long', year:'numeric' })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
