<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>81 İl Canlı Hava Durumu ve Avatar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            color: #fff;
        }

        #root {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* --- KATMAN 1: ARKA PLAN EFEKTLERİ --- */
        .bg-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* --- KATMAN 2: ANA İÇERİK --- */
        .content-layer {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* --- KATMAN 3: İNDİRME ALANI (GİZLİ & SABİT) --- */
        #profile-export-container {
            position: fixed;
            top: 0;
            left: -9999px; /* Ekran Dışı */
            width: 1080px;
            height: 1920px;
            z-index: -9999;
            background-color: #222;
            overflow: hidden;
            display: block; 
        }

        /* HAVA EFEKTİ STİLLERİ */
        .weather-bg-container { width: 100%; height: 100%; overflow: hidden; position: relative; }
        
        /* Güneşli */
        .bg-sun { background: linear-gradient(to bottom right, #2980b9, #6dd5fa, #ffffff); }
        .sun-orb { position: absolute; top: 5%; right: 5%; width: 250px; height: 250px; background: radial-gradient(circle, #fdbb2d 0%, rgba(253, 187, 45, 0.4) 60%, transparent 70%); filter: blur(20px); animation: pulseSun 6s infinite ease-in-out; }
        .sun-ray { position: absolute; top: 50%; left: 50%; width: 200vw; height: 150px; background: linear-gradient(90deg, rgba(255,255,255,0.1), transparent); transform-origin: left center; filter: blur(8px); }
        @keyframes pulseSun { 0%, 100% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.1); opacity: 1; } }

        /* Diğerleri */
        .bg-cloud { background: linear-gradient(to bottom, #757f9a, #d7dde8); }
        .bg-rain { background: linear-gradient(to bottom, #203a43, #2c5364); }
        .bg-snow { background: linear-gradient(to bottom, #83a4d4, #b6fbff); }
        .bg-storm { background: linear-gradient(to bottom, #232526, #414345); }

        /* Parçacıklar */
        .heavy-rain { position: absolute; background: rgba(255,255,255,0.6); width: 2px; height: 40px; animation: rainFall 0.7s linear infinite; }
        @keyframes rainFall { to { transform: translateY(110vh); } }
        .big-snow { position: absolute; background: white; border-radius: 50%; opacity: 0.8; animation: snowFall 5s linear infinite; }
        @keyframes snowFall { to { transform: translateY(110vh) rotate(360deg); } }
        .big-cloud { position: absolute; background: #fff; border-radius: 100px; opacity: 0.8; filter: blur(20px); animation: floatCloud 60s linear infinite; }
        @keyframes floatCloud { from { transform: translateX(-300px); } to { transform: translateX(120vw); } }
        .flash { position: absolute; inset: 0; background: white; opacity: 0; animation: thunder 6s infinite; }
        @keyframes thunder { 92% { opacity: 0; } 93% { opacity: 0.6; } 94% { opacity: 0; } }

        /* KART VE UI */
        .weather-card {
            position: relative;
            width: min(90vw, 600px);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 32px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .city-title { font-weight: 900; color: #fff; text-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        .glass-bar {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 9999px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .glass-bar:active { transform: scale(0.95); }
        
        /* İNDİRME ALANI STİLLERİ (SABİT POZİSYONLAR) */
        .export-content-wrapper {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
        }
        
        /* Başlık - Yukarıda */
        .exp-header {
            position: absolute; 
            top: 150px; 
            left: 0; width: 100%; 
            text-align: center;
        }
        
        /* Hava Durumu Kartı - Ortada */
        .exp-card {
            position: absolute; 
            top: 550px; /* Yukarı alındı */
            left: 50%; transform: translateX(-50%);
            width: 800px; padding: 40px;
            display: flex; align-items: center; justify-content: center; gap: 40px;
            background: rgba(0,0,0,0.5); border-radius: 50px; border: 4px solid rgba(255,255,255,0.3);
            color: white;
            box-shadow: 0 30px 80px rgba(0,0,0,0.4);
        }

        /* Avatar - Aşağıda */
        .exp-avatar {
            position: absolute; 
            bottom: 400px; /* Tarihin üstüne alındı */
            left: 50%; transform: translateX(-50%);
            width: 550px; height: 550px;
            border-radius: 50%; border: 15px solid white;
            overflow: hidden; background: white;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
        }

        /* Tarih - En Altta */
        .exp-date {
            position: absolute; bottom: 120px; left: 0; width: 100%; text-align: center;
        }

        /* Modal */
        .glass-modal { background: rgba(255,255,255,0.95); border-radius: 24px; color: #333; }
        select { background: #f3f4f6; border: 1px solid #ddd; }

        /* Favoriler Paneli */
        .favorites-sidebar {
            position: absolute;
            top: 2rem;
            left: 2rem;
            bottom: 8rem; /* Alt kısımdan boşluk */
            width: 280px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            z-index: 50;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .favorites-closed { transform: translateX(-120%); }
        .favorites-open { transform: translateX(0); }

        .fav-item {
            display: flex; align-items: center; justify-content: space-between; padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1); border-radius: 12px; margin-bottom: 0.5rem;
            cursor: pointer; transition: all 0.2s; color: white; border: 1px solid transparent;
        }
        .fav-item:hover { background: rgba(255, 255, 255, 0.2); border-color: rgba(255,255,255,0.3); }

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const TR_CITIES = [
            "Adana", "Adıyaman", "Afyonkarahisar", "Ağrı", "Amasya", "Ankara", "Antalya", "Artvin", "Aydın", "Balıkesir",
            "Bilecik", "Bingöl", "Bitlis", "Bolu", "Burdur", "Bursa", "Çanakkale", "Çankırı", "Çorum", "Denizli",
            "Diyarbakır", "Edirne", "Elazığ", "Erzincan", "Erzurum", "Eskişehir", "Gaziantep", "Giresun", "Gümüşhane", "Hakkari",
            "Hatay", "Isparta", "Mersin", "İstanbul", "İzmir", "Kars", "Kastamonu", "Kayseri", "Kırklareli", "Kırşehir",
            "Kocaeli", "Konya", "Kütahya", "Malatya", "Manisa", "Kahramanmaraş", "Mardin", "Muğla", "Muş", "Nevşehir",
            "Niğde", "Ordu", "Rize", "Sakarya", "Samsun", "Siirt", "Sinop", "Sivas", "Tekirdağ", "Tokat",
            "Trabzon", "Tunceli", "Şanlıurfa", "Uşak", "Van", "Yozgat", "Zonguldak", "Aksaray", "Bayburt", "Karaman",
            "Kırıkkale", "Batman", "Şırnak", "Bartın", "Ardahan", "Iğdır", "Yalova", "Karabük", "Kilis", "Osmaniye", "Düzce"
        ];

        const getWeatherInfo = (code) => {
            const map = {
                0: {t:"Güneşli", i:"sun", type:"sun"}, 1: {t:"Az Bulutlu", i:"cloud-sun", type:"partly-cloudy"}, 
                2: {t:"Parçalı Bulutlu", i:"cloud-sun", type:"cloud"}, 3: {t:"Kapalı", i:"cloud", type:"cloud"}, 
                45: {t:"Sisli", i:"cloud-fog", type:"cloud"}, 48: {t:"Kırağı", i:"cloud-fog", type:"cloud"},
                51: {t:"Çiseleme", i:"cloud-drizzle", type:"rain"}, 61: {t:"Yağmur", i:"cloud-rain", type:"rain"}, 
                63: {t:"Sağanak", i:"cloud-rain", type:"rain"}, 71: {t:"Kar", i:"snowflake", type:"snow"},
                73: {t:"Yoğun Kar", i:"snowflake", type:"snow"}, 95: {t:"Fırtına", i:"cloud-lightning", type:"storm"}
            };
            return map[code] || {t:"Bilinmiyor", i:"cloud", type:"cloud"};
        };

        const WeatherIcon = ({ iconName, size = 48, className = "" }) => {
            useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [iconName]);
            return <i data-lucide={iconName} width={size} height={size} className={className}></i>;
        };

        // --- HAVA EFEKTLERİ ---
        const BackgroundEffect = ({ type, isDay }) => {
            const elements = useMemo(() => {
                if (type === 'rain') {
                    return Array.from({ length: 100 }).map((_, i) => (
                        <div key={i} className="heavy-rain" style={{
                            left: `${Math.random() * 100}%`,
                            animationDuration: `${0.5 + Math.random() * 0.5}s`,
                            animationDelay: `-${Math.random()}s`,
                            opacity: 0.3 + Math.random() * 0.5
                        }} />
                    ));
                } else if (type === 'snow') {
                    return Array.from({ length: 60 }).map((_, i) => (
                        <div key={i} className="big-snow" style={{
                            left: `${Math.random() * 100}%`,
                            width: `${5 + Math.random() * 10}px`,
                            height: `${5 + Math.random() * 10}px`,
                            animationDuration: `${3 + Math.random() * 5}s`,
                            animationDelay: `-${Math.random() * 5}s`
                        }} />
                    ));
                } else if (type === 'cloud') {
                    return Array.from({ length: 6 }).map((_, i) => (
                        <div key={i} className="big-cloud" style={{
                            width: `${150 + Math.random() * 200}px`,
                            height: `${60 + Math.random() * 80}px`,
                            top: `${10 + Math.random() * 60}%`,
                            animationDuration: `${20 + Math.random() * 30}s`,
                            animationDelay: `-${Math.random() * 20}s`,
                            opacity: 0.6 + Math.random() * 0.3
                        }} />
                    ));
                } else if (type === 'sun' && isDay) {
                    return (
                        <>
                            <div className="sun-orb"></div>
                            <div className="sun-ray-container">
                                {[...Array(8)].map((_, i) => (
                                    <div key={i} className="sun-ray" style={{ transform: `rotate(${i * 45}deg)` }}></div>
                                ))}
                            </div>
                        </>
                    );
                } else if (type === 'storm') {
                    return <div className="flash"></div>;
                }
                return null;
            }, [type, isDay]);

            let bgClass = '';
            if (type === 'rain') bgClass = 'bg-rain';
            else if (type === 'snow') bgClass = 'bg-snow';
            else if (type === 'sun') bgClass = isDay ? 'bg-sun' : 'bg-storm';
            else if (type === 'cloud') bgClass = 'bg-cloud';
            else if (type === 'storm') bgClass = 'bg-storm';
            else bgClass = 'bg-cloud';

            return (
                <div className={`weather-bg-container ${bgClass}`}>
                    {elements}
                </div>
            );
        };

        // --- AVATAR MODALI (GELİŞMİŞ) ---
        const AvatarCreator = ({ onClose, onGenerate }) => {
            const [traits, setTraits] = useState({
                gender: "Woman", age: "Young Adult", skinTone: "Light", hairColor: "Brown", hairStyle: "Long Wavy",
                eyeColor: "Brown", clothingStyle: "Casual", mood: "Happy", glasses: "None", beard: "None", headwear: "None"
            });

            const renderSelect = (label, key, opts) => (
                <div>
                    <label className="block text-xs font-bold text-gray-500 mb-1">{label}</label>
                    <select className="custom-select w-full p-2.5 rounded-xl text-sm" value={traits[key]} onChange={e=>setTraits({...traits, [key]:e.target.value})}>
                        {opts.map(o=><option key={o} value={o}>{o}</option>)}
                    </select>
                </div>
            );

            return (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="glass-modal w-full max-w-lg p-6 relative max-h-[90vh] overflow-y-auto">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x" width="28"></i></button>
                        <h2 className="text-2xl font-black text-gray-800 mb-4 text-center">Avatarını Tasarla</h2>
                        <div className="space-y-3">
                            <div className="grid grid-cols-2 gap-3">
                                {renderSelect("Cinsiyet", "gender", ["Woman", "Man", "Girl", "Boy"])}
                                {renderSelect("Yaş Grubu", "age", ["Child", "Teen", "Young Adult", "Adult", "Elderly"])}
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {renderSelect("Ten Rengi", "skinTone", ["Light", "Tan", "Dark", "Pale"])}
                                {renderSelect("Saç Rengi", "hairColor", ["Brown", "Black", "Blonde", "Red", "Grey", "Pink"])}
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {renderSelect("Saç Stili", "hairStyle", ["Long Wavy", "Short Cut", "Ponytail", "Bald", "Hijab", "Curly"])}
                                {renderSelect("Göz Rengi", "eyeColor", ["Brown", "Blue", "Green", "Hazel", "Black"])}
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {renderSelect("Giyim Tarzı", "clothingStyle", ["Casual", "Sporty", "Formal", "Streetwear", "Traditional"])}
                                {renderSelect("Ruh Hali", "mood", ["Happy", "Cool", "Serious", "Surprised", "Sleepy"])}
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {renderSelect("Gözlük", "glasses", ["None", "Sunglasses", "Reading Glasses"])}
                                {renderSelect("Aksesuar/Şapka", "headwear", ["None", "Cap", "Beanie", "Hat"])}
                            </div>
                            {(traits.gender === "Man" || traits.gender === "Boy") && renderSelect("Sakal/Bıyık", "beard", ["None", "Full Beard", "Goatee", "Stubble"])}
                            
                            <div className="flex gap-2 mt-4">
                                <button onClick={onClose} className="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition-all">İptal</button>
                                <button onClick={()=>{onGenerate(traits); onClose();}} className="flex-[2] py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition-all">✨ Oluştur</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const FavoriteCityItem = ({ city, onClick, onRemove }) => {
            const [data, setData] = useState(null);
            useEffect(() => {
                let mounted = true;
                const load = async () => {
                    try {
                        const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=tr&format=json`).then(r=>r.json());
                        if(!geo.results || !mounted) return;
                        const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.results[0].latitude}&longitude=${geo.results[0].longitude}&current=temperature_2m,weather_code&timezone=auto`).then(r=>r.json());
                        if(mounted) setData({ temp: Math.round(w.current.temperature_2m), icon: getWeatherInfo(w.current.weather_code).i });
                    } catch(e) {}
                };
                load(); return () => mounted = false;
            }, [city]);

            return (
                <div onClick={onClick} className="fav-item group">
                    <div className="flex items-center gap-2"><span className="text-white font-bold truncate max-w-[120px]">{city}</span></div>
                    <div className="flex items-center gap-2">
                        {data ? <><span className="text-yellow-400 font-bold">{data.temp}°</span><div className="text-white/80 scale-75"><WeatherIcon iconName={data.icon} size={20}/></div></> : <div className="w-3 h-3 border-2 border-white rounded-full animate-spin"></div>}
                        <button onClick={(e) => { e.stopPropagation(); onRemove(city); }} className="text-white/40 hover:text-red-400 p-1 transition-colors opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" width="16"></i></button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [selectedCity, setSelectedCity] = useState("Eskişehir");
            const [weather, setWeather] = useState(null);
            const [loading, setLoading] = useState(true);
            const [avatarUrl, setAvatarUrl] = useState(null);
            const [avatarLoading, setAvatarLoading] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [savedCities, setSavedCities] = useState([]);
            const [isFavOpen, setIsFavOpen] = useState(false);
            const cardRef = useRef(null);

            useEffect(() => {
                const savedAvatar = localStorage.getItem('userAvatar');
                if (savedAvatar) setAvatarUrl(savedAvatar);
                setSavedCities(JSON.parse(localStorage.getItem('savedCities') || '[]'));
                fetchWeather(selectedCity);
            }, []);

            const fetchWeather = async (cityName) => {
                setLoading(true);
                try {
                    const geo = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${cityName}&count=1&language=tr&format=json`).then(r=>r.json());
                    if(!geo.results) throw new Error("Şehir bulunamadı");
                    const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.results[0].latitude}&longitude=${geo.results[0].longitude}&current=temperature_2m,is_day,weather_code&timezone=auto`).then(r=>r.json());
                    setWeather({
                        city: geo.results[0].name.toLocaleUpperCase('tr-TR'),
                        temp: Math.round(w.current.temperature_2m),
                        code: w.current.weather_code,
                        isDay: w.current.is_day === 1
                    });
                } catch(e) { console.error(e); } finally { setLoading(false); }
            };

            const generateAvatar = (traits) => {
                setAvatarLoading(true);
                let outfit = traits.clothingStyle;
                if(weather?.temp < 10) outfit += ", winter clothes, scarf";
                
                let extra = "";
                if(traits.glasses!=="None") extra+=`, ${traits.glasses}`;
                if(traits.beard!=="None") extra+=`, ${traits.beard}`;
                if(traits.headwear!=="None") extra+=`, wearing ${traits.headwear}`;
                
                const prompt = `cute 3d character portrait, ${traits.age} ${traits.gender}, ${traits.skinTone} skin, ${traits.hairStyle} ${traits.hairColor} hair, ${traits.eyeColor} eyes, ${traits.mood} expression, wearing ${outfit}${extra}, solid color background, 3d render, clay style, high quality, pixar style --no text`;
                
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=512&height=512&model=flux&nologo=true&seed=${Math.floor(Math.random()*1000)}`;
                setAvatarUrl(url); localStorage.setItem('userAvatar', url); setAvatarLoading(false);
            };

            const handleCityChange = (e) => { setSelectedCity(e.target.value); fetchWeather(e.target.value); };
            const refresh = () => fetchWeather(selectedCity);
            
            const saveCity = () => { 
                if (!savedCities.includes(selectedCity)) { 
                    const n = [...savedCities, selectedCity]; setSavedCities(n); localStorage.setItem('savedCities', JSON.stringify(n)); 
                    setIsFavOpen(true);
                } 
            };
            const removeCity = (c) => { const n = savedCities.filter(i => i !== c); setSavedCities(n); localStorage.setItem('savedCities', JSON.stringify(n)); };

            const download = () => {
                const target = document.getElementById('profile-export-container');
                if (!target) return;
                
                // --- KESİN ÇÖZÜM: Görünmez alana al, render et ---
                target.style.left = "0px"; 
                target.style.zIndex = "-9999"; // En arkada kalsın
                
                html2canvas(target, {
                    scale: 1, 
                    useCORS: true,
                    backgroundColor: "#1a1a1a", // Güvenli arka plan
                    width: 1080,
                    height: 1920,
                    scrollX: 0, scrollY: 0
                }).then(c => {
                    target.style.left = "-9999px"; // Sakla
                    const l = document.createElement('a'); l.download = `${selectedCity}_Hikaye.png`; l.href = c.toDataURL(); l.click();
                }).catch(() => target.style.left = "-9999px");
            };

            const dateStr = new Date().toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
            const wInfo = weather ? getWeatherInfo(weather.code) : {t:"", i:"cloud", type:"cloud"};

            const getTitleClass = (city) => {
                if (!city) return "text-5xl";
                if (city.length > 12) return "text-4xl md:text-5xl"; 
                return "text-6xl md:text-8xl"; 
            };

            return (
                <>
                    {/* WEB ARAYÜZÜ */}
                    <div className="content-layer">
                        <div className="bg-layer">
                            {weather && <BackgroundEffect type={wInfo.type} isDay={weather.isDay} />}
                        </div>
                        
                        {/* Favoriler Paneli */}
                        <div className={`favorites-sidebar custom-scrollbar overflow-y-auto ${isFavOpen ? 'favorites-open' : 'favorites-closed'}`}>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-white font-bold flex gap-2 text-lg"><i data-lucide="star" className="fill-yellow-400 text-yellow-400"></i> Favoriler</h3>
                                <button onClick={() => setIsFavOpen(false)} className="bg-white/10 p-1 rounded-full hover:bg-white/20 transition"><i data-lucide="x" width="20"></i></button>
                            </div>
                            <div className="space-y-2">
                                {savedCities.length === 0 && <div className="text-white/50 text-sm italic">Henüz favori yok.</div>}
                                {savedCities.map(c => <FavoriteCityItem key={c} city={c} onClick={() => {setSelectedCity(c); fetchWeather(c);}} onRemove={removeCity} />)}
                            </div>
                        </div>

                        <div ref={cardRef} className="weather-card animate-fade-in flex flex-col items-center justify-center">
                            {avatarUrl && (
                                <div className="absolute bottom-6 left-6 w-24 h-24 rounded-full border-4 border-white/40 shadow-2xl overflow-hidden bg-white z-30 hover:scale-105 transition-transform group">
                                    <img src={avatarUrl} className={`w-full h-full object-cover ${avatarLoading?'opacity-50':'opacity-100'}`} crossOrigin="anonymous"/>
                                    {avatarLoading && <div className="absolute inset-0 flex items-center justify-center"><div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div>}
                                    <button onClick={()=>{setAvatarUrl(null); localStorage.removeItem('userAvatar');}} className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity">X</button>
                                </div>
                            )}
                            {weather ? (
                                <div className="flex flex-col items-center z-10 w-full">
                                    <h1 className={`city-title ${getTitleClass(weather.city)} mb-4 drop-shadow-lg`}>{weather.city}</h1>
                                    <div className="flex items-center gap-4 bg-white/20 backdrop-blur-md px-8 py-4 rounded-3xl border border-white/40 shadow-2xl">
                                        <div className="text-white drop-shadow-md"><WeatherIcon iconName={wInfo.i} size={64} className="stroke-[2.5]" /></div>
                                        <div className="flex flex-col items-start"><span className="text-7xl font-black text-white drop-shadow-md weather-temp">{weather.temp}°</span><span className="text-xl font-bold text-white uppercase tracking-wide opacity-90">{wInfo.t}</span></div>
                                    </div>
                                    <span className="text-white/90 font-bold tracking-widest text-lg uppercase mt-6 drop-shadow-md">{dateStr}</span>
                                </div>
                            ) : <div className="text-white animate-pulse text-2xl font-bold flex flex-col items-center gap-2"><div className="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>Veriler Alınıyor...</div>}
                        </div>

                        <div className="search-container flex items-center gap-3 w-[min(90vw,600px)] mt-8">
                            {!isFavOpen && <button onClick={() => setIsFavOpen(true)} className="glass-bar p-4 text-white hover:bg-white hover:text-black tooltip" title="Favoriler"><i data-lucide="list" width="24"></i></button>}
                            
                            <div className="relative flex-grow group">
                                <select value={selectedCity} onChange={handleCityChange} className="city-select w-full p-4 pl-6 pr-10 glass-bar text-gray-800 font-extrabold focus:outline-none cursor-pointer text-lg appearance-none">{TR_CITIES.map(c => <option key={c} value={c}>{c}</option>)}</select>
                            </div>
                            <button onClick={saveCity} className="glass-bar p-4 text-yellow-500 hover:bg-white tooltip" title="Favori Ekle"><i data-lucide="star" className="fill-yellow-500" width="24"></i></button>
                            <button onClick={()=>setShowModal(true)} className="glass-bar p-4 text-gray-700 hover:bg-white tooltip" title="Avatar"><i data-lucide="user-plus" width="24"></i></button>
                            <button onClick={refresh} className="glass-bar p-4 text-gray-700 hover:bg-white tooltip" title="Yenile"><i data-lucide="refresh-cw" width="24"></i></button>
                            
                            <button onClick={download} className="glass-bar p-4 text-pink-600 hover:bg-white tooltip" title="İndir"><i data-lucide="download" width="24"></i></button>
                        </div>
                        {showModal && <AvatarCreator onClose={()=>setShowModal(false)} onGenerate={generateAvatar}/>}
                    </div>

                    {/* --- GİZLİ İNDİRME ALANI (SABİT PİKSEL) --- */}
                    <div id="profile-export-container">
                        {weather && <BackgroundEffect type={wInfo.type} isDay={weather.isDay} />}
                        <div className="export-content-wrapper">
                            
                            {/* 1. BAŞLIK */}
                            <div className="exp-header">
                                <h1 className="text-8xl font-black text-white drop-shadow-lg uppercase tracking-tighter" style={{textShadow:'0 5px 30px rgba(0,0,0,0.6)'}}>{weather?.city}</h1>
                            </div>

                            {/* 2. HAVA DURUMU KARTI */}
                            <div className="exp-card">
                                <div className="text-white scale-[2.5] drop-shadow-xl"><WeatherIcon iconName={wInfo.i} size={64}/></div>
                                <div className="flex flex-col items-center justify-center text-center">
                                    <span className="text-[140px] font-black leading-none drop-shadow-xl text-white">{weather?.temp}°</span>
                                    <span className="text-4xl font-bold text-white uppercase tracking-widest mt-2 bg-white/20 px-6 py-2 rounded-full">{wInfo.t}</span>
                                </div>
                            </div>

                            {/* 3. AVATAR */}
                            {avatarUrl ? (
                                <div className="exp-avatar">
                                    <img src={avatarUrl} className="w-full h-full object-cover" crossOrigin="anonymous"/>
                                </div>
                            ) : <div className="exp-avatar bg-white/10 flex items-center justify-center"><span className="text-white text-4xl opacity-50">Avatar Yok</span></div>}

                            {/* 4. TARİH */}
                            <div className="exp-date">
                                <span className="text-5xl font-bold text-white/90 uppercase tracking-[0.4em] drop-shadow-md">{dateStr}</span>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
